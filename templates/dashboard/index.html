{% extends 'base.html' %}

{% block title %}
{% if lang == 'es' %}Panel de Control - Market Stock{% else %}Dashboard - Market Stock{% endif %}
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="section-title mb-0">
                <i class="bi bi-speedometer2"></i>
                {% if lang == 'es' %}Panel de Control{% else %}Dashboard{% endif %}
            </h1>
            <div class="text-secondary">
                <i class="bi bi-clock me-1"></i>
                <span class="last-update-time">{{ last_update|time:"H:i:s" }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Market Indices -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-graph-up me-2"></i>
                    {% if lang == 'es' %}Índices Principales{% else %}Major Indices{% endif %}
                </span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th>{% if lang == 'es' %}Índice{% else %}Index{% endif %}</th>
                                <th class="text-end">{% if lang == 'es' %}Nivel{% else %}Level{% endif %}</th>
                                <th class="text-end">{% if lang == 'es' %}Cambio{% else %}Change{% endif %}</th>
                                <th class="text-end">{% if lang == 'es' %}Cambio %{% else %}Change %{% endif %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in indices %}
                            <tr>
                                <td>
                                    <strong>{{ item.index.name }}</strong>
                                    <small class="text-secondary ms-2">{{ item.index.symbol }}</small>
                                </td>
                                <td class="text-end">
                                    {% if item.price %}
                                    {{ item.price.level|floatformat:2 }}
                                    {% else %}
                                    --
                                    {% endif %}
                                </td>
                                <td class="text-end {% if item.price.change > 0 %}price-up{% elif item.price.change < 0 %}price-down{% endif %}">
                                    {% if item.price and item.price.change %}
                                    {% if item.price.change > 0 %}+{% endif %}{{ item.price.change|floatformat:2 }}
                                    {% else %}
                                    --
                                    {% endif %}
                                </td>
                                <td class="text-end {% if item.price.change_percent > 0 %}price-up{% elif item.price.change_percent < 0 %}price-down{% endif %}">
                                    {% if item.price and item.price.change_percent %}
                                    {% if item.price.change_percent > 0 %}+{% endif %}{{ item.price.change_percent|floatformat:2 }}%
                                    {% else %}
                                    --
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-secondary">
                                    {% if lang == 'es' %}No hay datos disponibles{% else %}No data available{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tracked Stocks -->
<div class="row mb-4">
    <div class="col-12">
        <h2 class="section-title">
            <i class="bi bi-collection"></i>
            {% if lang == 'es' %}Acciones Rastreadas{% else %}Tracked Stocks{% endif %}
        </h2>
    </div>
</div>

<div class="row g-4">
    {% for item in stocks %}
    <div class="col-md-6 col-lg-4">
        <div class="card stock-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <a href="{% url 'dashboard:stock_detail' item.stock.symbol %}" class="text-decoration-none text-white">
                        <strong>{{ item.stock.symbol }}</strong>
                    </a>
                    <span class="sector-badge ms-2">{{ item.stock.sector }}</span>
                </div>
                {% if item.analysis %}
                <span class="badge {% if item.analysis.sentiment == 'BULLISH' %}badge-bullish{% elif item.analysis.sentiment == 'BEARISH' %}badge-bearish{% else %}badge-neutral{% endif %}">
                    {{ item.analysis.sentiment }}
                </span>
                {% endif %}
            </div>
            <div class="card-body">
                <h6 class="text-secondary mb-3">{{ item.stock.name }}</h6>

                <div class="row mb-3">
                    <div class="col-4">
                        <div class="metric-label">{% if lang == 'es' %}Precio{% else %}Price{% endif %}</div>
                        <div class="metric-value">
                            {% if item.price %}
                            ${{ item.price.price|floatformat:2 }}
                            {% else %}
                            --
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="metric-label">{% if lang == 'es' %}Cambio ${% else %}Change ${% endif %}</div>
                        <div class="metric-value {% if item.price.change > 0 %}price-up{% elif item.price.change < 0 %}price-down{% endif %}">
                            {% if item.price and item.price.change %}
                            {% if item.price.change > 0 %}+{% endif %}${{ item.price.change|floatformat:2 }}
                            {% else %}
                            --
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="metric-label">{% if lang == 'es' %}Cambio %{% else %}Change %{% endif %}</div>
                        <div class="metric-value {% if item.price.change_percent > 0 %}price-up{% elif item.price.change_percent < 0 %}price-down{% endif %}">
                            {% if item.price and item.price.change_percent %}
                            {% if item.price.change_percent > 0 %}+{% endif %}{{ item.price.change_percent|floatformat:2 }}%
                            {% else %}
                            --
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if item.analysis %}
                <div class="row">
                    <div class="col-4">
                        <div class="metric-label">P/E</div>
                        <div class="metric-value">
                            {% if item.analysis.pe_trailing %}
                            {{ item.analysis.pe_trailing|floatformat:1 }}x
                            {% else %}--{% endif %}
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="metric-label">D/E</div>
                        <div class="metric-value">
                            {% if item.analysis.debt_equity %}
                            {{ item.analysis.debt_equity|floatformat:2 }}
                            {% else %}--{% endif %}
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="metric-label">{% if lang == 'es' %}Calificación{% else %}Rating{% endif %}</div>
                        <div class="metric-value rating-{{ item.analysis.rating|lower|slugify }}">
                            {% if item.analysis.rating == 'STRONG_BUY' %}
                                {% if lang == 'es' %}COMPRA F.{% else %}STRONG BUY{% endif %}
                            {% elif item.analysis.rating == 'BUY' %}
                                {% if lang == 'es' %}COMPRA{% else %}BUY{% endif %}
                            {% elif item.analysis.rating == 'HOLD' %}
                                {% if lang == 'es' %}MANTENER{% else %}HOLD{% endif %}
                            {% elif item.analysis.rating == 'SELL' %}
                                {% if lang == 'es' %}VENTA{% else %}SELL{% endif %}
                            {% elif item.analysis.rating == 'HIGH_RISK' %}
                                {% if lang == 'es' %}ALTO RIESGO{% else %}HIGH RISK{% endif %}
                            {% else %}
                                {{ item.analysis.rating }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-transparent border-top-0">
                <a href="{% url 'dashboard:stock_detail' item.stock.symbol %}" class="btn btn-outline-light btn-sm w-100">
                    {% if lang == 'es' %}Ver Detalles{% else %}View Details{% endif %}
                    <i class="bi bi-arrow-right ms-1"></i>
                </a>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="alert alert-secondary">
            {% if lang == 'es' %}No hay acciones rastreadas{% else %}No tracked stocks{% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Recent News -->
<div class="row mt-5">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-newspaper me-2"></i>
                    {% if lang == 'es' %}Noticias Recientes{% else %}Recent News{% endif %}
                </span>
                <a href="{% url 'dashboard:news_report' %}" class="btn btn-sm btn-outline-light">
                    {% if lang == 'es' %}Ver Todas{% else %}View All{% endif %}
                </a>
            </div>
            <div class="card-body">
                {% for news in recent_news %}
                <div class="news-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="badge bg-primary me-2">{{ news.stock.symbol }}</span>
                            <a href="{{ news.url }}" target="_blank" class="news-headline">
                                {% if lang == 'es' and news.headline_es %}
                                {{ news.headline_es }}
                                {% else %}
                                {{ news.headline }}
                                {% endif %}
                            </a>
                        </div>
                    </div>
                    <div class="news-source mt-1">
                        {{ news.source }} • {{ news.published_at|date:"M d, H:i"|default:news.created_at|date:"M d, H:i" }}
                    </div>
                </div>
                {% empty %}
                <p class="text-secondary mb-0">
                    {% if lang == 'es' %}No hay noticias disponibles{% else %}No news available{% endif %}
                </p>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-globe me-2"></i>
                {% if lang == 'es' %}Noticias del Mercado{% else %}Market News{% endif %}
            </div>
            <div class="card-body">
                {% for news in market_news %}
                <div class="news-item">
                    <a href="{{ news.url }}" target="_blank" class="news-headline small">
                        {% if lang == 'es' and news.headline_es %}
                        {{ news.headline_es }}
                        {% else %}
                        {{ news.headline }}
                        {% endif %}
                    </a>
                    <div class="news-source">
                        {{ news.source }}
                    </div>
                </div>
                {% empty %}
                <p class="text-secondary mb-0 small">
                    {% if lang == 'es' %}No hay noticias{% else %}No news{% endif %}
                </p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
