version: '3.8'

services:
  web:
    build: .
    container_name: marketstock_app
    command: python manage.py runserver 0.0.0.0:8008
    volumes:
      - .:/app
      - media_files:/app/media
    ports:
      - "8008:8008"
    environment:
      - ALLOWED_HOSTS=marketstock.jorgecuenca.com,localhost,127.0.0.1
    restart: unless-stopped
    stdin_open: true
    tty: true

  scheduler:
    build: .
    container_name: marketstock_scheduler
    command: python manage.py run_scheduler --price-interval=60 --news-interval=300 --analysis-interval=3600
    volumes:
      - .:/app
      - media_files:/app/media
    environment:
      - ALLOWED_HOSTS=marketstock.jorgecuenca.com,localhost,127.0.0.1
    depends_on:
      - web
    restart: unless-stopped

  https-portal:
    image: steveltn/https-portal:1
    container_name: marketstock_https
    ports:
      - '80:80'
      - '443:443'
    environment:
      DOMAINS: 'marketstock.jorgecuenca.com -> http://web:8008'
      STAGE: 'production'
      CLIENT_MAX_BODY_SIZE: 50M
    volumes:
      - https-portal-data:/var/lib/https-portal
    depends_on:
      - web
    restart: unless-stopped

volumes:
  media_files:
  https-portal-data:
